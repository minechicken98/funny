<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Battle Cats Game</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap"
            rel="stylesheet"
        />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family: "Luckiest Guy", cursive;
                background: linear-gradient(
                    135deg,
                    #87ceeb 0%,
                    #5bb5e0 50%,
                    #b4f080 100%
                );
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                align-items: center;
                overflow: hidden;
            }
            h1 {
                color: #5bb5e0;
                margin: 10px 0;
                font-size: 2em;
            }
            #gameCanvas {
                border: 4px solid #333;
                border-radius: 10px;
                background: linear-gradient(
                    to bottom,
                    #87ceeb 0%,
                    #87ceeb 60%,
                    #90ee90 60%,
                    #228b22 100%
                );
            }
            .controls {
                display: flex;
                gap: 10px;
                margin: 10px;
                flex-wrap: wrap;
                justify-content: center;
            }
            .cat-btn {
                padding: 10px;
                border: 3px solid #333;
                border-radius: 10px;
                cursor: pointer;
                background: white;
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 80px;
                transition: all 0.2s;
            }
            .cat-btn:hover:not(:disabled) {
                transform: scale(1.1);
                background: #b4f080;
            }
            .cat-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .cat-btn img {
                width: 50px;
                height: 50px;
                object-fit: contain;
            }
            .cat-btn .cost {
                font-size: 0.8em;
                color: #666;
            }
            .cat-btn .key {
                font-size: 0.7em;
                background: #333;
                color: white;
                padding: 2px 6px;
                border-radius: 4px;
            }
            .cat-btn {
                position: relative;
                overflow: hidden;
            }
            .cat-btn .cooldown-bar {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 0%;
                background: rgba(0, 0, 0, 0.6);
                transition: height 0.1s linear;
                pointer-events: none;
            }
            .stats {
                display: flex;
                gap: 30px;
                margin: 10px;
                font-size: 1.2em;
            }
            .stat {
                background: white;
                padding: 10px 20px;
                border-radius: 10px;
                border: 3px solid #333;
            }
            .back-btn {
                position: absolute;
                top: 10px;
                left: 10px;
                padding: 10px 20px;
                background: linear-gradient(135deg, #87ceeb, #5bb5e0);
                color: white;
                border: none;
                border-radius: 10px;
                font-family: "Luckiest Guy", cursive;
                font-size: 1em;
                cursor: pointer;
                text-decoration: none;
            }
            .back-btn:hover {
                transform: scale(1.05);
            }
        </style>
    </head>
    <body>
        <a href="index.html" class="back-btn">‚Üê Back</a>
        <h1>üê± Battle Cats üê±</h1>

        <div class="stats">
            <div class="stat">Level <span id="levelNum">1</span></div>
            <div class="stat"><span id="money">500</span>¬¢</div>
            <div class="stat"><span id="xpDisplay">0</span> XP</div>
        </div>

        <canvas id="gameCanvas" width="900" height="400"></canvas>

        <div class="controls">
            <button class="cat-btn" onclick="spawnCat('cat')" id="btn-cat">
                <div class="cooldown-bar" id="cd-cat"></div>
                <img src="images/cat.png" alt="Cat" />
                <span class="cost">75¬¢</span>
                <span class="key">1</span>
            </button>
            <button class="cat-btn" onclick="spawnCat('tank')" id="btn-tank">
                <div class="cooldown-bar" id="cd-tank"></div>
                <img src="images/tank.png" alt="Tank" />
                <span class="cost">150¬¢</span>
                <span class="key">2</span>
            </button>
            <button class="cat-btn" onclick="spawnCat('axe')" id="btn-axe">
                <div class="cooldown-bar" id="cd-axe"></div>
                <img src="images/axe.png" alt="Axe" />
                <span class="cost">300¬¢</span>
                <span class="key">3</span>
            </button>
            <button class="cat-btn" onclick="spawnCat('gross')" id="btn-gross">
                <div class="cooldown-bar" id="cd-gross"></div>
                <img src="images/gross.webp" alt="Gross" />
                <span class="cost">600¬¢</span>
                <span class="key">4</span>
            </button>
            <button class="cat-btn" onclick="spawnCat('cow')" id="btn-cow">
                <div class="cooldown-bar" id="cd-cow"></div>
                <img src="images/cow.webp" alt="Cow" />
                <span class="cost">750¬¢</span>
                <span class="key">5</span>
            </button>
            <button class="cat-btn" onclick="spawnCat('bird')" id="btn-bird">
                <div class="cooldown-bar" id="cd-bird"></div>
                <img src="images/bird.png" alt="Bird" />
                <span class="cost">925¬¢</span>
                <span class="key">6</span>
            </button>
            <button class="cat-btn" onclick="spawnCat('fish')" id="btn-fish">
                <div class="cooldown-bar" id="cd-fish"></div>
                <img src="images/fish.png" alt="Fish" />
                <span class="cost">1200¬¢</span>
                <span class="key">7</span>
            </button>
            <button
                class="cat-btn"
                onclick="spawnCat('lizard')"
                id="btn-lizard"
            >
                <div class="cooldown-bar" id="cd-lizard"></div>
                <img src="images/lizard.png" alt="Lizard" />
                <span class="cost">1500¬¢</span>
                <span class="key">8</span>
            </button>
            <button class="cat-btn" onclick="spawnCat('titan')" id="btn-titan">
                <div class="cooldown-bar" id="cd-titan"></div>
                <img src="images/titan.png" alt="Titan" />
                <span class="cost">1950¬¢</span>
                <span class="key">9</span>
            </button>
            <button
                class="cat-btn"
                onclick="spawnCat('cosmo')"
                id="btn-cosmo"
                style="display: none"
            >
                <div class="cooldown-bar" id="cd-cosmo"></div>
                <img src="images/cosmo.png" alt="Cosmo" />
                <span class="cost">5000¬¢</span>
                <span class="key">0</span>
            </button>
        </div>

        <script>
            const canvas = document.getElementById("gameCanvas");
            const ctx = canvas.getContext("2d");

            let money = 500;
            let baseHP = 1000;
            let enemyHP = 1000;
            let cats = [];
            let enemies = [];
            let gameOver = false;
            let levelWon = false;
            let paused = false;
            let level = 1;
            let enemySpawnRate = 3000;
            let totalXP = 0;
            let lastXPReward = 0;
            let showingUpgrades = false;
            let upgradeScroll = 0;
            let showCosmoUnlock = false;

            // Cooldowns for each cat (in milliseconds) - halved
            const catCooldowns = {
                cat: 2500,
                tank: 4000,
                axe: 3500,
                gross: 5500,
                cow: 4500,
                bird: 4165,
                fish: 6500,
                lizard: 9500,
                titan: 13500,
                cosmo: 60000,
            };

            // Track when each cat was last spawned
            const catLastSpawn = {
                cat: 0,
                tank: 0,
                axe: 0,
                gross: 0,
                cow: 0,
                bird: 0,
                fish: 0,
                lizard: 0,
                titan: 0,
                cosmo: 0,
            };

            // Track upgrade levels for each cat (affects hp and damage)
            let baseMaxHP = 1000;
            let baseUpgradeLevel = 0;

            const catUpgrades = {
                cat: 0,
                tank: 0,
                axe: 0,
                gross: 0,
                cow: 0,
                bird: 0,
                fish: 0,
                lizard: 0,
                titan: 0,
                cosmo: 0,
            };

            function getUpgradeCost(catType) {
                const baseCost = 1000;
                const level = catUpgrades[catType];
                return Math.floor(baseCost * Math.pow(1.5, level));
            }

            function upgradeCat(catType) {
                const cost = getUpgradeCost(catType);
                if (totalXP >= cost) {
                    totalXP -= cost;
                    catUpgrades[catType]++;
                    // Increase base stats
                    catStats[catType].hp = Math.floor(
                        catStats[catType].hp * 1.1,
                    );
                    catStats[catType].damage = Math.floor(
                        catStats[catType].damage * 1.1,
                    );
                    updateUI();
                }
            }

            function getBaseUpgradeCost() {
                return Math.floor(2000 * Math.pow(1.5, baseUpgradeLevel));
            }

            function upgradeBase() {
                const cost = getBaseUpgradeCost();
                if (totalXP >= cost) {
                    totalXP -= cost;
                    baseUpgradeLevel++;
                    baseMaxHP = Math.floor(baseMaxHP * 1.15);
                    updateUI();
                }
            }

            const levels = [
                {
                    enemyHP: 1000,
                    spawnRate: 3000,
                    enemyMultiplier: 1,
                    xpMin: 5000,
                    xpMax: 10000,
                },
                {
                    enemyHP: 1500,
                    spawnRate: 2500,
                    enemyMultiplier: 1.2,
                    xpMin: 10000,
                    xpMax: 20000,
                },
                {
                    enemyHP: 2000,
                    spawnRate: 2200,
                    enemyMultiplier: 1.5,
                    xpMin: 20000,
                    xpMax: 30000,
                },
                {
                    enemyHP: 3000,
                    spawnRate: 2000,
                    enemyMultiplier: 1.8,
                    xpMin: 30000,
                    xpMax: 40000,
                },
                {
                    enemyHP: 4000,
                    spawnRate: 1800,
                    enemyMultiplier: 2.2,
                    xpMin: 40000,
                    xpMax: 50000,
                },
                {
                    enemyHP: 5000,
                    spawnRate: 1500,
                    enemyMultiplier: 2.5,
                    xpMin: 50000,
                    xpMax: 60000,
                },
                {
                    enemyHP: 7000,
                    spawnRate: 1300,
                    enemyMultiplier: 3,
                    xpMin: 60000,
                    xpMax: 70000,
                },
                {
                    enemyHP: 10000,
                    spawnRate: 1000,
                    enemyMultiplier: 4,
                    xpMin: 100000,
                    xpMax: 200000,
                },
                {
                    enemyHP: 15000,
                    spawnRate: 800,
                    enemyMultiplier: 5,
                    xpMin: 200000,
                    xpMax: 500000,
                },
                {
                    enemyHP: 25000,
                    spawnRate: 600,
                    enemyMultiplier: 7,
                    xpMin: 500000,
                    xpMax: 1000000,
                },
            ];

            const catStats = {
                cat: {
                    cost: 75,
                    hp: 100,
                    damage: 20,
                    speed: 2,
                    attackSpeed: 1000,
                    range: 50,
                },
                tank: {
                    cost: 150,
                    hp: 300,
                    damage: 10,
                    speed: 1,
                    attackSpeed: 1500,
                    range: 40,
                },
                axe: {
                    cost: 300,
                    hp: 80,
                    damage: 35,
                    speed: 2.5,
                    attackSpeed: 800,
                    range: 45,
                },
                gross: {
                    cost: 600,
                    hp: 150,
                    damage: 25,
                    speed: 1.5,
                    attackSpeed: 1200,
                    range: 100,
                },
                cow: {
                    cost: 750,
                    hp: 200,
                    damage: 40,
                    speed: 3,
                    attackSpeed: 1000,
                    range: 50,
                },
                bird: {
                    cost: 925,
                    hp: 60,
                    damage: 50,
                    speed: 2,
                    attackSpeed: 600,
                    range: 120,
                    flies: true,
                },
                fish: {
                    cost: 1200,
                    hp: 180,
                    damage: 30,
                    speed: 1.8,
                    attackSpeed: 1100,
                    range: 60,
                },
                lizard: {
                    cost: 1500,
                    hp: 120,
                    damage: 60,
                    speed: 1.5,
                    attackSpeed: 1400,
                    range: 150,
                },
                titan: {
                    cost: 1950,
                    hp: 500,
                    damage: 80,
                    speed: 0.8,
                    attackSpeed: 2000,
                    range: 60,
                },
                cosmo: {
                    cost: 5000,
                    hp: 99999,
                    damage: 10000,
                    speed: 1.5,
                    attackSpeed: 500,
                    range: 1000,
                    unlockLevel: 10,
                },
            };

            const enemyTypes = [
                {
                    name: "Doge",
                    hp: 80,
                    damage: 15,
                    speed: 0.75,
                    attackSpeed: 1000,
                    range: 40,
                    color: "#FFD700",
                },
                {
                    name: "Snache",
                    hp: 50,
                    damage: 25,
                    speed: 1.25,
                    attackSpeed: 800,
                    range: 35,
                    color: "#00FF00",
                },
                {
                    name: "Pigge",
                    hp: 150,
                    damage: 20,
                    speed: 0.5,
                    attackSpeed: 1200,
                    range: 45,
                    color: "#FFC0CB",
                },
                {
                    name: "Gory",
                    hp: 200,
                    damage: 40,
                    speed: 0.6,
                    attackSpeed: 1500,
                    range: 50,
                    color: "#8B0000",
                },
            ];

            // Load cat images
            const catImages = {};
            const catNames = [
                "cat",
                "tank",
                "axe",
                "gross",
                "cow",
                "bird",
                "fish",
                "lizard",
                "titan",
                "cosmo",
            ];
            catNames.forEach((name) => {
                catImages[name] = new Image();
                const ext = name === "gross" || name === "cow" ? "webp" : "png";
                catImages[name].src = `images/${name}.${ext}`;
            });

            function spawnCat(type) {
                if (gameOver || paused || levelWon) return;
                const stats = catStats[type];
                const now = Date.now();
                const cooldown = catCooldowns[type];
                const timeSinceSpawn = now - catLastSpawn[type];

                // Check if on cooldown
                if (timeSinceSpawn < cooldown) return;

                if (money >= stats.cost) {
                    money -= stats.cost;
                    catLastSpawn[type] = now;
                    const isBird = type === "bird";
                    cats.push({
                        type: type,
                        x: canvas.width - 80,
                        y: isBird ? 220 : 280 + Math.random() * 40,
                        flies: isBird,
                        hp: stats.hp,
                        maxHp: stats.hp,
                        damage: stats.damage,
                        speed: stats.speed,
                        attackSpeed: stats.attackSpeed,
                        range: stats.range,
                        lastAttack: 0,
                        attacking: false,
                    });
                    updateUI();
                }
            }

            function spawnEnemy() {
                if (gameOver) return;
                const levelData = levels[level - 1];
                const mult = levelData.enemyMultiplier;
                const type =
                    enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                enemies.push({
                    name: type.name,
                    x: 80,
                    y: 280 + Math.random() * 40,
                    hp: Math.floor(type.hp * mult),
                    maxHp: Math.floor(type.hp * mult),
                    damage: Math.floor(type.damage * mult),
                    speed: type.speed,
                    attackSpeed: type.attackSpeed,
                    range: type.range,
                    color: type.color,
                    lastAttack: 0,
                    attacking: false,
                });
            }

            function togglePause() {
                paused = !paused;
            }

            function drawPauseButton() {
                // Draw pause button in top left of canvas
                const x = 10;
                const y = 15;

                ctx.fillStyle = "rgba(0,0,0,0.5)";
                ctx.fillRect(x, y, 30, 30);
                ctx.fillStyle = "white";

                if (paused) {
                    // Play triangle
                    ctx.beginPath();
                    ctx.moveTo(x + 10, y + 5);
                    ctx.lineTo(x + 10, y + 25);
                    ctx.lineTo(x + 25, y + 15);
                    ctx.closePath();
                    ctx.fill();
                } else {
                    // Two vertical bars
                    ctx.fillRect(x + 8, y + 6, 5, 18);
                    ctx.fillRect(x + 17, y + 6, 5, 18);
                }
            }

            function startNextLevel() {
                level++;
                levelWon = false;
                const levelData = levels[level - 1];
                enemyHP = levelData.enemyHP;
                enemySpawnRate = levelData.spawnRate;
                cats = [];
                enemies = [];
                money = 500 + (level - 1) * 200;
                baseHP = baseMaxHP;

                // Restart enemy spawner with new rate
                clearInterval(enemySpawner);
                enemySpawner = setInterval(() => {
                    if (!gameOver && !paused && !levelWon) spawnEnemy();
                }, enemySpawnRate);

                updateUI();
            }

            function retryLevel() {
                gameOver = false;
                levelWon = false;
                const levelData = levels[level - 1];
                enemyHP = levelData.enemyHP;
                enemySpawnRate = levelData.spawnRate;
                cats = [];
                enemies = [];
                money = 500 + (level - 1) * 200;
                baseHP = baseMaxHP;

                // Restart enemy spawner with new rate
                clearInterval(enemySpawner);
                enemySpawner = setInterval(() => {
                    if (!gameOver && !paused && !levelWon) spawnEnemy();
                }, enemySpawnRate);

                updateUI();
            }

            function updateUI() {
                document.getElementById("money").textContent =
                    Math.floor(money);
                document.getElementById("levelNum").textContent = level;
                document.getElementById("xpDisplay").textContent =
                    totalXP.toLocaleString();

                const now = Date.now();

                // Update button states and cooldowns
                for (const [name, stats] of Object.entries(catStats)) {
                    const btn = document.getElementById(`btn-${name}`);
                    const cdBar = document.getElementById(`cd-${name}`);
                    const timeSinceSpawn = now - catLastSpawn[name];
                    const cooldown = catCooldowns[name];
                    const onCooldown = timeSinceSpawn < cooldown;

                    // Check if cat is locked (cosmo unlocks at level 10)
                    const unlockLevel = stats.unlockLevel || 1;
                    const isLocked = level < unlockLevel;

                    if (isLocked) {
                        btn.style.display = "none";
                    } else {
                        btn.style.display = "flex";
                        btn.disabled = money < stats.cost || onCooldown;
                    }

                    // Update cooldown bar (starts full, shrinks down)
                    if (onCooldown && !isLocked) {
                        const remaining = cooldown - timeSinceSpawn;
                        const percent = (remaining / cooldown) * 100;
                        cdBar.style.height = percent + "%";
                    } else {
                        cdBar.style.height = "0%";
                    }
                }
            }

            function drawBase(x, hp, maxHp, isEnemy) {
                ctx.fillStyle = isEnemy ? "#8B0000" : "#4169E1";
                ctx.fillRect(x, 200, 60, 150);
                ctx.fillStyle = "#333";
                ctx.fillRect(x + 15, 280, 30, 70);

                // HP text above base
                ctx.fillStyle = "#000";
                ctx.font = "bold 14px Arial";
                ctx.textAlign = "center";
                ctx.fillText(`${Math.floor(hp)}/${maxHp}`, x + 30, 190);
            }

            function drawCat(cat) {
                const isTitan = cat.type === "titan";
                const isBird = cat.type === "bird";
                const drawY = isBird ? cat.y : isTitan ? cat.y : 300;
                // Different sizes for each cat type
                const sizes = {
                    cat: 50,
                    tank: 90,
                    axe: 70,
                    gross: 70,
                    cow: 75,
                    bird: 70,
                    fish: 70,
                    lizard: 70,
                    titan: 100,
                    cosmo: 120,
                };
                const size = sizes[cat.type] || 70;
                const img = catImages[cat.type];

                ctx.save();
                ctx.translate(cat.x, drawY);

                if (img && img.complete) {
                    ctx.drawImage(img, -size / 2, -size / 2, size, size);
                }

                ctx.restore();

                // HP bar
                ctx.fillStyle = "#333";
                ctx.fillRect(cat.x - 20, drawY - size / 2 - 10, 40, 5);
                ctx.fillStyle = "#00FF00";
                ctx.fillRect(
                    cat.x - 20,
                    drawY - size / 2 - 10,
                    40 * (cat.hp / cat.maxHp),
                    5,
                );
            }

            function drawEnemy(enemy) {
                ctx.fillStyle = enemy.color;
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, 25, 0, Math.PI * 2);
                ctx.fill();

                // Face
                ctx.fillStyle = "white";
                ctx.beginPath();
                ctx.arc(enemy.x - 8, enemy.y - 5, 6, 0, Math.PI * 2);
                ctx.arc(enemy.x + 8, enemy.y - 5, 6, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = "black";
                ctx.beginPath();
                ctx.arc(enemy.x - 8, enemy.y - 5, 3, 0, Math.PI * 2);
                ctx.arc(enemy.x + 8, enemy.y - 5, 3, 0, Math.PI * 2);
                ctx.fill();

                // HP bar
                ctx.fillStyle = "#333";
                ctx.fillRect(enemy.x - 25, enemy.y - 40, 50, 6);
                ctx.fillStyle = "#FF0000";
                ctx.fillRect(
                    enemy.x - 25,
                    enemy.y - 40,
                    50 * (enemy.hp / enemy.maxHp),
                    6,
                );

                // Name
                ctx.fillStyle = "white";
                ctx.font = "12px Arial";
                ctx.textAlign = "center";
                ctx.fillText(enemy.name, enemy.x, enemy.y + 40);
            }

            function update(timestamp) {
                if (gameOver || paused || levelWon) return;

                // Money generation
                money += 3.5;

                // Update cats
                cats.forEach((cat) => {
                    cat.attacking = false;

                    // Check for enemies in range (enemies are to the left now)
                    let target = null;
                    let minDist = Infinity;
                    enemies.forEach((enemy) => {
                        const dist = cat.x - enemy.x;
                        if (dist > 0 && dist < minDist) {
                            minDist = dist;
                            target = enemy;
                        }
                    });

                    // Check if can attack enemy base (on the left at x=10)
                    const distToBase = cat.x - 70;

                    if (target && minDist <= cat.range) {
                        cat.attacking = true;
                        if (timestamp - cat.lastAttack >= cat.attackSpeed) {
                            target.hp -= cat.damage;
                            cat.lastAttack = timestamp;
                        }
                    } else if (distToBase <= cat.range) {
                        cat.attacking = true;
                        if (timestamp - cat.lastAttack >= cat.attackSpeed) {
                            enemyHP -= cat.damage;
                            cat.lastAttack = timestamp;
                        }
                    } else {
                        cat.x -= cat.speed;
                    }
                });

                // Update enemies
                enemies.forEach((enemy) => {
                    enemy.attacking = false;

                    // Check for cats in range (cats are to the right now)
                    let target = null;
                    let minDist = Infinity;
                    cats.forEach((cat) => {
                        const dist = cat.x - enemy.x;
                        if (dist > 0 && dist < minDist) {
                            minDist = dist;
                            target = cat;
                        }
                    });

                    // Check if can attack player base (on the right now)
                    const distToBase = canvas.width - 60 - enemy.x;

                    if (target && minDist <= enemy.range) {
                        enemy.attacking = true;
                        if (timestamp - enemy.lastAttack >= enemy.attackSpeed) {
                            target.hp -= enemy.damage;
                            enemy.lastAttack = timestamp;
                        }
                    } else if (distToBase <= enemy.range) {
                        enemy.attacking = true;
                        if (timestamp - enemy.lastAttack >= enemy.attackSpeed) {
                            baseHP -= enemy.damage;
                            enemy.lastAttack = timestamp;
                        }
                    } else {
                        enemy.x += enemy.speed;
                    }
                });

                // Remove dead units
                cats = cats.filter((cat) => cat.hp > 0);
                enemies = enemies.filter((enemy) => enemy.hp > 0);

                // Check win/lose
                if (baseHP <= 0) {
                    gameOver = true;
                }
                if (enemyHP <= 0 && !levelWon) {
                    if (level >= levels.length) {
                        gameOver = true;
                    } else {
                        const lvlData = levels[level - 1];
                        const range = lvlData.xpMax - lvlData.xpMin;
                        lastXPReward =
                            Math.floor(Math.random() * (range + 1)) +
                            lvlData.xpMin;
                        totalXP += lastXPReward;
                        levelWon = true;

                        // Unlock Cosmo popup after beating level 9
                        if (level === 9) {
                            showCosmoUnlock = true;
                        }
                    }
                }

                updateUI();
            }

            function draw() {
                // Clear
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Background
                ctx.fillStyle = "#87CEEB";
                ctx.fillRect(0, 0, canvas.width, 250);
                ctx.fillStyle = "#90EE90";
                ctx.fillRect(0, 250, canvas.width, 150);

                // Ground line
                ctx.strokeStyle = "#228B22";
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(0, 250);
                ctx.lineTo(canvas.width, 250);
                ctx.stroke();

                // Draw bases
                const levelData = levels[level - 1];
                drawBase(10, enemyHP, levelData.enemyHP, true);
                drawBase(canvas.width - 70, baseHP, baseMaxHP, false);

                // Draw units
                cats.forEach(drawCat);
                enemies.forEach(drawEnemy);

                // Draw pause button
                drawPauseButton();

                // Paused text
                if (paused) {
                    ctx.fillStyle = "rgba(0,0,0,0.5)";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = "white";
                    ctx.font = "48px Luckiest Guy";
                    ctx.textAlign = "center";
                    ctx.fillText("PAUSED", canvas.width / 2, canvas.height / 2);
                }

                // Level won text
                if (levelWon && !showingUpgrades) {
                    ctx.fillStyle = "rgba(0,0,0,0.7)";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = "white";
                    ctx.font = "48px Luckiest Guy";
                    ctx.textAlign = "center";
                    ctx.fillText(
                        "VICTORY!",
                        canvas.width / 2,
                        canvas.height / 2 - 80,
                    );

                    // XP reward
                    ctx.font = "28px Luckiest Guy";
                    ctx.fillStyle = "#FFD700";
                    ctx.fillText(
                        "+" + lastXPReward.toLocaleString() + " XP",
                        canvas.width / 2,
                        canvas.height / 2 - 35,
                    );

                    // Draw Upgrade button
                    const upgBtnX = canvas.width / 2 - 170;
                    const btnY = canvas.height / 2 + 10;
                    ctx.fillStyle = "#FF9800";
                    ctx.fillRect(upgBtnX, btnY, 150, 50);
                    ctx.fillStyle = "white";
                    ctx.font = "24px Luckiest Guy";
                    ctx.fillText("Upgrade", upgBtnX + 75, btnY + 35);

                    // Draw Next Level button
                    const nextBtnX = canvas.width / 2 + 20;
                    ctx.fillStyle = "#4CAF50";
                    ctx.fillRect(nextBtnX, btnY, 150, 50);
                    ctx.fillStyle = "white";
                    ctx.fillText("Next Level", nextBtnX + 75, btnY + 35);
                }

                // Upgrade screen
                if (showingUpgrades) {
                    ctx.fillStyle = "rgba(0,0,0,0.9)";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    ctx.fillStyle = "white";
                    ctx.font = "36px Luckiest Guy";
                    ctx.textAlign = "center";
                    ctx.fillText("UPGRADE CATS", canvas.width / 2, 40);

                    ctx.font = "20px Luckiest Guy";
                    ctx.fillStyle = "#FFD700";
                    ctx.fillText(
                        "XP: " + totalXP.toLocaleString(),
                        canvas.width / 2,
                        70,
                    );

                    // Draw cat upgrade options (only show unlocked cats)
                    const startY = 80;
                    const itemHeight = 28;
                    const unlockedCats = catNames.filter((name) => {
                        const unlockLevel = catStats[name].unlockLevel || 1;
                        return level >= unlockLevel;
                    });
                    unlockedCats.forEach((name, i) => {
                        const y = startY + i * itemHeight;
                        const cost = getUpgradeCost(name);
                        const lvl = catUpgrades[name];
                        const canAfford = totalXP >= cost;

                        // Background
                        ctx.fillStyle = canAfford
                            ? "rgba(255,255,255,0.2)"
                            : "rgba(255,255,255,0.1)";
                        ctx.fillRect(50, y, canvas.width - 100, 24);

                        // Cat name and level
                        ctx.fillStyle = "white";
                        ctx.font = "14px Luckiest Guy";
                        ctx.textAlign = "left";
                        ctx.fillText(
                            name.toUpperCase() + " (Lv." + lvl + ")",
                            70,
                            y + 20,
                        );

                        // Stats
                        ctx.font = "12px Arial";
                        ctx.fillStyle = "#AAA";
                        ctx.fillText(
                            "HP: " +
                                catStats[name].hp +
                                " DMG: " +
                                catStats[name].damage,
                            200,
                            y + 20,
                        );

                        // Upgrade button
                        ctx.fillStyle = canAfford ? "#4CAF50" : "#666";
                        ctx.fillRect(canvas.width - 180, y + 2, 120, 20);
                        ctx.fillStyle = "white";
                        ctx.font = "12px Luckiest Guy";
                        ctx.textAlign = "center";
                        ctx.fillText(
                            cost.toLocaleString() + " XP",
                            canvas.width - 120,
                            y + 20,
                        );
                    });

                    // Base health upgrade row
                    const baseY = startY + unlockedCats.length * itemHeight;
                    const baseCost = getBaseUpgradeCost();
                    const canAffordBase = totalXP >= baseCost;

                    ctx.fillStyle = canAffordBase
                        ? "rgba(100,150,255,0.3)"
                        : "rgba(100,150,255,0.15)";
                    ctx.fillRect(50, baseY, canvas.width - 100, 24);

                    ctx.fillStyle = "#4169E1";
                    ctx.font = "14px Luckiest Guy";
                    ctx.textAlign = "left";
                    ctx.fillText(
                        "BASE HP (Lv." + baseUpgradeLevel + ")",
                        70,
                        baseY + 20,
                    );

                    ctx.font = "12px Arial";
                    ctx.fillStyle = "#AAA";
                    ctx.fillText("HP: " + baseMaxHP, 200, baseY + 20);

                    ctx.fillStyle = canAffordBase ? "#4CAF50" : "#666";
                    ctx.fillRect(canvas.width - 180, baseY + 2, 120, 20);
                    ctx.fillStyle = "white";
                    ctx.font = "12px Luckiest Guy";
                    ctx.textAlign = "center";
                    ctx.fillText(
                        baseCost.toLocaleString() + " XP",
                        canvas.width - 120,
                        baseY + 20,
                    );

                    // Back button
                    ctx.fillStyle = "#f44336";
                    ctx.fillRect(
                        canvas.width / 2 - 60,
                        canvas.height - 50,
                        120,
                        40,
                    );
                    ctx.fillStyle = "white";
                    ctx.font = "20px Luckiest Guy";
                    ctx.textAlign = "center";
                    ctx.fillText("Back", canvas.width / 2, canvas.height - 22);
                }

                // Game over text
                if (gameOver) {
                    ctx.fillStyle = "rgba(0,0,0,0.7)";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = "white";
                    ctx.font = "48px Luckiest Guy";
                    ctx.textAlign = "center";
                    ctx.fillText(
                        enemyHP <= 0 ? "YOU WIN!" : "GAME OVER",
                        canvas.width / 2,
                        canvas.height / 2 - 30,
                    );

                    // Retry button
                    ctx.fillStyle = "#4CAF50";
                    ctx.fillRect(
                        canvas.width / 2 - 60,
                        canvas.height / 2 + 10,
                        120,
                        45,
                    );
                    ctx.fillStyle = "white";
                    ctx.font = "24px Luckiest Guy";
                    ctx.fillText(
                        "RETRY",
                        canvas.width / 2,
                        canvas.height / 2 + 42,
                    );
                }

                // Cosmo unlock popup
                if (showCosmoUnlock) {
                    ctx.fillStyle = "rgba(0,0,0,0.85)";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    ctx.fillStyle = "#FFD700";
                    ctx.font = "36px Luckiest Guy";
                    ctx.textAlign = "center";
                    ctx.fillText("NEW CAT UNLOCKED!", canvas.width / 2, 80);

                    // Draw Cosmo image
                    const cosmoImg = catImages["cosmo"];
                    if (cosmoImg && cosmoImg.complete) {
                        ctx.drawImage(
                            cosmoImg,
                            canvas.width / 2 - 75,
                            100,
                            150,
                            150,
                        );
                    }

                    ctx.fillStyle = "white";
                    ctx.font = "28px Luckiest Guy";
                    ctx.fillText("SUPER NOVA COSMO", canvas.width / 2, 290);

                    ctx.font = "16px Arial";
                    ctx.fillStyle = "#AAA";
                    ctx.fillText(
                        "99,999 HP | 10,000 DMG | 1,000 Range",
                        canvas.width / 2,
                        320,
                    );

                    // OK button
                    ctx.fillStyle = "#4CAF50";
                    ctx.fillRect(canvas.width / 2 - 60, 340, 120, 40);
                    ctx.fillStyle = "white";
                    ctx.font = "20px Luckiest Guy";
                    ctx.fillText("AWESOME!", canvas.width / 2, 368);
                }
            }

            function gameLoop(timestamp) {
                update(timestamp);
                draw();
                requestAnimationFrame(gameLoop);
            }

            // Spawn enemies periodically
            let enemySpawner = setInterval(() => {
                if (!gameOver && !paused && !levelWon) spawnEnemy();
            }, enemySpawnRate);

            // Keyboard controls
            document.addEventListener("keydown", (e) => {
                const keyMap = {
                    1: "cat",
                    2: "tank",
                    3: "axe",
                    4: "gross",
                    5: "cow",
                    6: "bird",
                    7: "fish",
                    8: "lizard",
                    9: "titan",
                    0: "cosmo",
                };
                if (keyMap[e.key]) spawnCat(keyMap[e.key]);
            });

            // Canvas click for pause button and next level button
            canvas.addEventListener("click", (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Check if clicked on pause button (top left)
                if (x >= 10 && x <= 40 && y >= 15 && y <= 45) {
                    togglePause();
                }

                // Cosmo unlock popup - AWESOME button
                if (showCosmoUnlock) {
                    if (
                        x >= canvas.width / 2 - 60 &&
                        x <= canvas.width / 2 + 60 &&
                        y >= 340 &&
                        y <= 380
                    ) {
                        showCosmoUnlock = false;
                    }
                    return; // Don't process other clicks while popup is showing
                }

                // Retry button on game over
                if (gameOver) {
                    if (
                        x >= canvas.width / 2 - 60 &&
                        x <= canvas.width / 2 + 60 &&
                        y >= canvas.height / 2 + 10 &&
                        y <= canvas.height / 2 + 55
                    ) {
                        retryLevel();
                    }
                    return;
                }

                // Check if clicked on victory screen buttons
                if (levelWon && !showingUpgrades) {
                    const btnY = canvas.height / 2 + 10;

                    // Upgrade button
                    const upgBtnX = canvas.width / 2 - 170;
                    if (
                        x >= upgBtnX &&
                        x <= upgBtnX + 150 &&
                        y >= btnY &&
                        y <= btnY + 50
                    ) {
                        showingUpgrades = true;
                    }

                    // Next Level button
                    const nextBtnX = canvas.width / 2 + 20;
                    if (
                        x >= nextBtnX &&
                        x <= nextBtnX + 150 &&
                        y >= btnY &&
                        y <= btnY + 50
                    ) {
                        startNextLevel();
                    }
                }

                // Check if clicked on upgrade screen
                if (showingUpgrades) {
                    // Back button
                    if (
                        x >= canvas.width / 2 - 60 &&
                        x <= canvas.width / 2 + 60 &&
                        y >= canvas.height - 50 &&
                        y <= canvas.height - 10
                    ) {
                        showingUpgrades = false;
                    }

                    // Upgrade buttons for each cat (only unlocked)
                    const startY = 80;
                    const itemHeight = 28;
                    const unlockedCats = catNames.filter((name) => {
                        const unlockLevel = catStats[name].unlockLevel || 1;
                        return level >= unlockLevel;
                    });
                    unlockedCats.forEach((name, i) => {
                        const btnY = startY + i * itemHeight + 2;
                        if (
                            x >= canvas.width - 180 &&
                            x <= canvas.width - 60 &&
                            y >= btnY &&
                            y <= btnY + 20
                        ) {
                            upgradeCat(name);
                        }
                    });

                    // Base upgrade button
                    const baseY = startY + unlockedCats.length * itemHeight + 2;
                    if (
                        x >= canvas.width - 180 &&
                        x <= canvas.width - 60 &&
                        y >= baseY &&
                        y <= baseY + 20
                    ) {
                        upgradeBase();
                    }
                }
            });

            // Start game
            requestAnimationFrame(gameLoop);
        </script>
    </body>
</html>
